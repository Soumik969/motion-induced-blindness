<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optics Project: MIB Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: #0f172a;
            color: #f1f5f9;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
        }

        /* Modal Styles */
        #login-modal {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            z-index: 100;
        }

        canvas {
            border-radius: 1rem;
            box-shadow: 0 0 60px rgba(59, 130, 246, 0.25);
            max-width: 100%;
            height: auto;
            cursor: crosshair;
        }

        .scroll-section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.4);
        }

        .preset-btn {
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .preset-btn.active {
            background: #2563eb;
            border-color: #60a5fa;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.4);
        }

        .toggle-btn {
            transition: all 0.2s;
        }
        .toggle-btn.selected {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        #timer-glow {
            transition: all 0.3s ease;
        }
        .recording-active #timer-glow {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            border-color: rgba(239, 68, 68, 0.5);
        }
    </style>
</head>
<body class="overflow-hidden"> <div id="login-modal" class="fixed inset-0 flex items-center justify-center p-4">
        <div class="glass-panel p-10 max-w-md w-full text-center border border-blue-500/30 shadow-2xl shadow-blue-500/20">
            <h1 class="text-3xl font-bold mb-2 text-white">Welcome Researcher</h1>
            <p class="text-slate-400 mb-8">Please enter your name to begin the MIB Analysis session.</p>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="text" id="participantNameInput" required placeholder="Enter your name..." 
                    class="w-full bg-slate-800 border border-slate-600 rounded-lg p-4 text-center text-lg text-white placeholder-slate-500 focus:ring-2 ring-blue-500 outline-none transition-all">
                
                <button type="submit" class="w-full btn-primary py-4 rounded-lg font-bold text-lg shadow-lg text-white">
                    Enter Laboratory
                </button>
            </form>
        </div>
    </div>

    <section class="scroll-section" id="welcome">
        <div class="max-w-3xl text-center">
            <h1 class="text-6xl font-extrabold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-300">
                Visual Perception Lab
            </h1>
            <p class="text-xl text-slate-300 mb-8 leading-relaxed">
                Measuring Motion-Induced Blindness (MIB). <br>
                <span class="text-sm text-slate-400">Research Objective: Measure the suppression of static targets within a high-density rotating blue mask.</span>
            </p>
            <a href="#simulator" class="btn-primary px-8 py-4 rounded-full text-lg font-semibold inline-block">
                Start Experiment
            </a>
        </div>
    </section>

    <section class="scroll-section" id="simulator">
        <div class="w-full max-w-7xl flex flex-col lg:flex-row gap-8 items-start">
            
            <div class="glass-panel p-8 w-full lg:w-1/3 space-y-6">
                
                <div>
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Experimental Variables
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="border-b border-slate-700 pb-4">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Target Color</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="setTargetColor('#fbbf24')" id="colorYellow" class="toggle-btn selected py-2 rounded-lg border border-slate-600 bg-slate-800 text-sm flex items-center justify-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-yellow-400"></span> Yellow
                                </button>
                                <button onclick="setTargetColor('#f97316')" id="colorOrange" class="toggle-btn py-2 rounded-lg border border-slate-600 bg-slate-800 text-sm flex items-center justify-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-orange-500"></span> Orange
                                </button>
                            </div>
                        </div>

                        <div class="border-b border-slate-700 pb-4">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Target Quantity</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setTargetCount(1)" id="btn1Targets" class="toggle-btn py-2 rounded-lg border border-slate-600 bg-slate-800 text-sm">1</button>
                                <button onclick="setTargetCount(2)" id="btn2Targets" class="toggle-btn py-2 rounded-lg border border-slate-600 bg-slate-800 text-sm">2</button>
                                <button onclick="setTargetCount(3)" id="btn3Targets" class="toggle-btn selected py-2 rounded-lg border border-slate-600 bg-slate-800 text-sm">3</button>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Mask Presets</label>
                            <div class="flex flex-col gap-2">
                                <button onclick="setPreset(0)" id="preset0" class="preset-btn active text-left px-4 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 flex justify-between items-center group">
                                    <div class="flex flex-col">
                                        <span class="font-medium text-sm text-white">1. Dense Static Targets</span>
                                        <span class="text-[10px] text-blue-400 uppercase font-bold">Standard 1800-Dot Mask</span>
                                    </div>
                                </button>
                                <button onclick="setPreset(1)" id="preset1" class="preset-btn text-left px-4 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 flex justify-between items-center group">
                                    <div class="flex flex-col">
                                        <span class="font-medium text-sm text-white">2. Vibration (Jitter)</span>
                                        <span class="text-[10px] text-red-400 uppercase font-bold">Target Motion Noise</span>
                                    </div>
                                </button>
                                <button onclick="setPreset(2)" id="preset2" class="preset-btn text-left px-4 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 flex justify-between items-center group">
                                    <div class="flex flex-col">
                                        <span class="font-medium text-sm text-white">3. Low Intensity Mask</span>
                                        <span class="text-[10px] text-slate-400 uppercase font-bold">Faint Blue Background</span>
                                    </div>
                                </button>
                                <button onclick="setPreset(3)" id="preset3" class="preset-btn text-left px-4 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 flex justify-between items-center group">
                                    <div class="flex flex-col">
                                        <span class="font-medium text-sm text-white">4. Mask Interference</span>
                                        <span class="text-[10px] text-cyan-400 uppercase font-bold">Large Dot Masking</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-6 border-t border-slate-700">
                    <div id="timer-glow" class="glass-panel p-6 text-center border-2 border-transparent transition-all">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-1">Live Measurement</label>
                        <div id="liveTimer" class="text-4xl font-mono font-bold text-white mb-4">00.00s</div>
                        <button id="recordToggle" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold transition-all shadow-lg text-white text-lg">
                            START DISAPPEARANCE
                        </button>
                    </div>
                </div>
            </div>

            <div class="relative w-full lg:w-2/3 flex flex-col items-center">
                <canvas id="mibCanvas" width="600" height="600" class="bg-black"></canvas>
                
                <div class="mt-6 grid grid-cols-2 md:grid-cols-3 gap-4 w-full">
                    <div class="glass-panel px-6 py-4 text-center">
                        <span class="block text-2xl font-bold text-blue-400" id="latencyDisplay">0.0s</span>
                        <span class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Avg. Duration</span>
                    </div>
                    <div class="glass-panel px-6 py-4 text-center">
                        <span class="block text-2xl font-bold text-emerald-400" id="freqDisplay">0</span>
                        <span class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Total Events</span>
                    </div>
                    <div class="glass-panel px-6 py-4 text-center col-span-2 md:col-span-1">
                        <span class="block text-2xl font-bold text-amber-400" id="totalTimeDisplay">0s</span>
                        <span class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Total Blindness</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="scroll-section" id="survey">
        <div class="glass-panel p-10 w-full max-w-3xl">
            <h2 class="text-3xl font-bold mb-6 text-white">Laboratory Data Sheet</h2>
            
            <div id="submissionMessage" class="hidden mb-4 p-4 rounded-lg bg-green-500/20 text-green-300 border border-green-500/50"></div>

            <form id="mibForm" onsubmit="submitToGoogleSheet(event)" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Participant Name</label>
                        <input type="text" id="displayParticipantName" readonly class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 outline-none text-slate-400 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Current Variable Set</label>
                        <input type="text" id="variableDisplay" readonly class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-slate-400" value="Yellow Targets, No Vibration">
                    </div>
                </div>

                <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
                    <h3 class="text-xs font-bold text-blue-400 mb-4 uppercase tracking-widest">Logged Suppression Events</h3>
                    <div id="captureSummary" class="text-sm font-mono text-slate-300 min-h-[100px] max-h-[200px] overflow-y-auto custom-scrollbar">
                        Waiting for experimental data...
                    </div>
                </div>

                <button type="submit" id="submitBtn" class="w-full btn-primary py-4 rounded-lg font-bold text-lg shadow-xl text-white flex items-center justify-center gap-2">
                    <span>Export to Google Sheet</span>
                </button>
            </form>
        </div>
    </section>

    <script>
        // --- CONFIGURATION ---
        // Your Verified Script URL
        const scriptURL = "https://script.google.com/macros/s/AKfycbyURuWfOLdZ9l28zqlUuiXewU5C-kLyZIpCwvJDjTIEPk2GIanwOlRb4Nesc8gswzOb/exec"; 
        
        let participantName = "";

        // --- LOGIN LOGIC ---
        function handleLogin(e) {
            e.preventDefault();
            const input = document.getElementById('participantNameInput');
            if (input.value.trim() !== "") {
                participantName = input.value;
                document.getElementById('displayParticipantName').value = participantName;
                document.getElementById('login-modal').style.display = 'none';
                document.body.classList.remove('overflow-hidden');
            }
        }

        // --- CANVAS LOGIC ---
        const canvas = document.getElementById('mibCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const recordBtn = document.getElementById('recordToggle');
        const liveTimer = document.getElementById('liveTimer');
        
        const presets = [
            { name: "Standard Dense", speed: 25, size: 6, density: 1800, dotColor: '#3b82f6', contrast: 1.0, vibration: false },
            { name: "Vibration Jitter", speed: 25, size: 6, density: 1800, dotColor: '#3b82f6', contrast: 1.0, vibration: true }, 
            { name: "Low Intensity Mask", speed: 25, size: 6, density: 1800, dotColor: '#3b82f6', contrast: 0.25, vibration: false },
            { name: "Mask Interference", speed: 25, size: 16, density: 2500, dotColor: '#3b82f6', contrast: 1.0, vibration: false }
        ];

        let currentSettings = presets[0];
        let targetCount = 3;
        let targetColor = '#fbbf24'; // Yellow Default
        let angle = 0;
        
        let isRecording = false;
        let recordingStartTime = 0;
        let timerInterval = null;
        let events = [];
        let bgDots = [];

        function setTargetColor(color) {
            targetColor = color;
            document.getElementById('colorYellow').classList.toggle('selected', color === '#fbbf24');
            document.getElementById('colorOrange').classList.toggle('selected', color === '#f97316');
            updateSummaryDisplay();
        }

        function setTargetCount(count) {
            targetCount = count;
            for(let i=1; i<=3; i++) {
                document.getElementById(`btn${i}Targets`)?.classList.toggle('selected', i === count);
            }
            events = []; 
            updateUI();
        }

        function setPreset(index) {
            currentSettings = presets[index];
            document.querySelectorAll('.preset-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            events = [];
            updateUI();
            updateSummaryDisplay();
            initBgDots();
        }

        function updateSummaryDisplay() {
            const colorName = targetColor === '#fbbf24' ? 'Yellow' : 'Orange';
            const vibStatus = currentSettings.vibration ? 'With Vibration' : 'No Vibration';
            const intensityStatus = currentSettings.contrast < 1 ? 'Low Intensity' : 'Standard Intensity';
            document.getElementById('variableDisplay').value = `${colorName} Targets, ${vibStatus}, ${intensityStatus}`;
        }

        function initBgDots() {
            bgDots = [];
            const count = currentSettings.density;
            for(let i=0; i<count; i++) {
                const dist = Math.sqrt(Math.random()) * 580;
                const theta = Math.random() * Math.PI * 2;
                bgDots.push({
                    x: Math.cos(theta) * dist,
                    y: Math.sin(theta) * dist,
                    size: Math.random() * 2.5 + 0.5
                });
            }
        }

        function getTargetAngles() {
            if (targetCount === 1) return [90];
            if (targetCount === 2) return [0, 180];
            return [30, 150, 270];
        }

        function draw() {
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const speed = currentSettings.speed / 1000;

            // 1. Mask
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(angle);
            ctx.fillStyle = currentSettings.dotColor;
            ctx.globalAlpha = currentSettings.contrast;
            for (let i = 0; i < bgDots.length; i++) {
                const dot = bgDots[i];
                ctx.beginPath();
                ctx.arc(dot.x, dot.y, dot.size, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
            ctx.globalAlpha = 1.0;

            // 2. Targets (With optional Vibration Jitter)
            ctx.fillStyle = targetColor;
            const targetSize = currentSettings.size;
            const dist = 140;
            const angles = getTargetAngles(); 
            
            angles.forEach(deg => {
                const r = deg * Math.PI / 180;
                let jitterX = 0;
                let jitterY = 0;
                
                if (currentSettings.vibration) {
                    jitterX = (Math.random() - 0.5) * 4; // High frequency low amplitude noise
                    jitterY = (Math.random() - 0.5) * 4;
                }

                ctx.beginPath();
                ctx.arc(
                    centerX + Math.cos(r) * dist + jitterX, 
                    centerY + Math.sin(r) * dist + jitterY, 
                    targetSize, 0, Math.PI * 2
                );
                ctx.fill();
            });

            // 3. Fixation
            const blink = Math.floor(Date.now() / 400) % 2 === 0;
            ctx.strokeStyle = blink ? '#4ade80' : '#ffffff';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(centerX - 15, centerY); ctx.lineTo(centerX + 15, centerY);
            ctx.moveTo(centerX, centerY - 15); ctx.lineTo(centerX, centerY + 15);
            ctx.stroke();

            angle += speed;
            requestAnimationFrame(draw);
        }

        recordBtn.addEventListener('click', () => {
            if(!isRecording) {
                isRecording = true;
                recordingStartTime = Date.now();
                document.body.classList.add('recording-active');
                recordBtn.innerText = "REAPPEARED (STOP)";
                recordBtn.classList.replace('bg-blue-600', 'bg-red-500');
                timerInterval = setInterval(() => {
                    const diff = (Date.now() - recordingStartTime) / 1000;
                    liveTimer.innerText = diff.toFixed(2).padStart(5, '0') + 's';
                }, 10);
            } else {
                const duration = (Date.now() - recordingStartTime) / 1000;
                events.push(duration);
                clearInterval(timerInterval);
                isRecording = false;
                document.body.classList.remove('recording-active');
                recordBtn.innerText = "START DISAPPEARANCE";
                recordBtn.classList.replace('bg-red-500', 'bg-blue-600');
                liveTimer.innerText = "00.00s";
                updateUI();
            }
        });

        function updateUI() {
            const freq = events.length;
            const total = events.reduce((a, b) => a + b, 0);
            const avg = freq > 0 ? (total / freq) : 0;
            document.getElementById('freqDisplay').innerText = freq;
            document.getElementById('latencyDisplay').innerText = avg.toFixed(1) + 's';
            document.getElementById('totalTimeDisplay').innerText = total.toFixed(1) + 's';
            const summary = document.getElementById('captureSummary');
            if(events.length === 0) {
                summary.innerText = "Waiting for experimental data...";
            } else {
                summary.innerHTML = events.map((dur, i) => `
                    <div class="flex justify-between py-1 border-b border-slate-800">
                        <span class="text-slate-500">Event #${i+1}</span>
                        <span class="text-blue-400 font-bold">${dur.toFixed(2)}s disappearance</span>
                    </div>
                `).join('');
            }
        }

        // --- SUBMIT TO GOOGLE SHEET ---
        function submitToGoogleSheet(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('submissionMessage');
            
            // Gather data
            const freq = events.length;
            const total = events.reduce((a, b) => a + b, 0);
            const avg = freq > 0 ? (total / freq) : 0;
            const variableSet = document.getElementById('variableDisplay').value;

            if (freq === 0) {
                alert("No data recorded yet! Please run the experiment first.");
                return;
            }

            btn.innerText = "Sending...";
            btn.disabled = true;

            const payload = {
                name: participantName,
                variable: variableSet,
                avg: avg.toFixed(2),
                events: freq
            };

            fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors', // Important for Google Sheets
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                msg.innerText = "Data successfully saved to Laboratory Database.";
                msg.classList.remove('hidden');
                btn.innerText = "Export Success";
                btn.classList.replace('btn-primary', 'bg-green-600');
                
                // Optional: clear data for next round
                setTimeout(() => {
                   msg.classList.add('hidden');
                   btn.disabled = false;
                   btn.innerText = "Export to Google Sheet";
                   btn.classList.replace('bg-green-600', 'btn-primary');
                }, 3000);
            })
            .catch(error => {
                console.error('Error!', error.message);
                btn.innerText = "Error (Try Again)";
                btn.disabled = false;
            });
        }

        window.onload = () => {
            setPreset(0);
            draw();
        };
    </script>
</body>
</html>

